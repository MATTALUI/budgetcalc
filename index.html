<!DOCTYPE html>
<html>
  <head>

    <!-- jquery -->
    <script
  src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
  integrity="sha256-3edrmyuQ0w65f8gfBsqowzjJe2iM6n0nKciPUp8y+7E="
  crossorigin="anonymous"></script>

    <!-- bootstrap 4 -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" charset="utf-8"></script>
    <!-- <link rel="stylesheet" href="https://bootswatch.com/4/solar/bootstrap.min.css"> -->

    <!-- font awesome -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">

    <!-- handlebars -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.11/handlebars.min.js" charset="utf-8"></script>

    <!-- canvasjs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/canvasjs/1.7.0/canvasjs.min.js" charset="utf-8"></script>

  </head>
  <body class="">

    <style>
      a.canvasjs-chart-credit{
        display: none;
      }
      .tiny-font{
        font-size: .7em;
      }
    </style>

    <nav class="navbar navbar-expand-lg  navbar-dark bg-dark">
      <h2><a class="navbar-brand text-light" >Budget Calculator</a></h2>
    </nav>
    <br/>
    <div class="container">
      <h4 class="text-center">How it works...</h4>
      <div class="row">
        <p class="text-center">
          Use "plus" buttons to add either sources of income or expenses. Expenses can be added as either dollar-values or as income percentages. If you would like some advice on budget-building recommendations, click <a href="https://www.youtube.com/watch?v=dQw4w9WgXcQ">here</a>.
        </p>
      </div>
      <hr/>
      <h4 class="text-center">INCOME</h4>
      <div id="income-control-box" class="row mb-3">
        <button id="add-income-button" class="col-sm-1 offset-sm-11 btn btn-success">
          <i class="fas fa-plus"></i>
        </button>
      </div>

      <div id="income-container" class="row">
      </div>

      <div id="income-total-box" class="row">
        <span class="bold col-sm-8"><strong> TOTAL MONTHLY INCOME</strong></span>
        <input id="income-total" type="Number" value="0.00" class="form-control col-sm-4 text-right" readonly/>
      </div>


      <hr/>
      <h4 class="text-center">Expenses</h4>
      <div id="expense-control-box" class="row mb-3">
        <button id="add-expense-button" class="col-sm-1 offset-sm-11 btn btn-danger">
          <i class="fas fa-plus"></i>
        </button>
      </div>


      <div id="expense-container" class="row">
      </div>


      <div id="epense-total-box" class="row mb-3">
        <span class="bold col-sm-8"><strong>TOTAL MONTHLY EXPENSES</strong></span>
        <input id="expense-total" type="Number" value="0.00" class="form-control col-sm-4 text-right" readonly/>
      </div>

      <div class="row mb-3">
        <!-- <span class="bold col-sm-8"><strong>DIFFERENCE</strong></span> -->
        <input id="diff-box" type="text" class="form-control text-right col-sm-4 offset-sm-8" value="$0.00" readonly/>
      </div>

    </div>

    <div id="chartContainer" style="height: 300px; width: 100%;"></div>

    <div class="container mb-5">
      <div class="row">
        <button id="new-budget" class="btn btn-sm btn-primary col-sm-4 btn-outline-dark">New Budget</button>
        <button id="load-budget" class="btn btn-sm btn-primary col-sm-4 btn-outline-dark">Load Budget</button>
        <button id="save-budget-modal-trigger" class="btn btn-sm btn-primary col-sm-4 btn-outline-dark">Save Budget</button>
      </div>
    </div>



    <div id="saveModal" class="modal" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Save Budget</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="container">
              <div class="row">
                <input id="save-name" class="form-control" placeholder="Budget Name"></input>
                <span class="tiny-font">All budgets are saved locally. To reaccess your budget, please load it using the same device you saved it on.</span>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button id="save-budget" type="button" class="btn btn-outline-dark">Save changes</button>
            <button type="button" class="btn btn-outline-dark" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>











    <script>
      $(document).ready(()=>{
        $(document).on('click','.remove-button',(event)=>{
          let row = $(event.target).closest('.source').remove();
          calculateIncomeTotals('income');
        });

        $(document).on('change','.income-input',(event)=>{
          calculateIncomeTotals();
        });

        $(document).on('change','.expense-input',(event)=>{
          updateExpenseViews();
        });

        $('#new-budget').on('click', ()=>{resetBudget(true)});

        $('#load-budget').on('click', loadBudget);

        $('#save-budget-modal-trigger').on('click', saveBudgetModal);

        $('#save-budget').on('click', saveBudget);

        $('#add-income-button').on('click', addIncome);

        $('#add-expense-button').on('click', addExpense);
        // addExpense();
        // addExpense();
      });

      let addIncome = ()=>{
        let source = $('#income-template').html();
        let template = Handlebars.compile(source);
        let html = template();
        $('#income-container').append(html);
      }

      let addExpense = ()=>{
        let source = $('#expense-template').html();
        let template = Handlebars.compile(source);
        let html = template();
        $('#expense-container').append(html);
      }

      function updateExpenseViews(){
        let $expenseValuePanel = $(event.target).closest('.expense').find('.expense-value');
        let inputValue = $(event.target).val();
        if(inputValue.indexOf('%') > -1){
          let incomeTotal = +($('#income-total').val());
          let percentage = $(event.target).val().split('%')[0];
          if(isNaN(percentage)){
            $(event.target).val('');
            $expenseValuePanel.html('$0.00');
          }else{
            percentage = +percentage;
            let value = (incomeTotal * (percentage/100)).toFixed(2);
            $expenseValuePanel.html(`$${value}`);
          }
        }else if(isNaN(inputValue)){
          $(event.target).val('');
          $expenseValuePanel.html('$0.00');
        }else{
          $expenseValuePanel.html(`$${(+inputValue).toFixed(2)}`);
        }
        calculateExpenseTotals();
      }

      function calculateExpenseTotals(){
        let total = 0;
        $('.expense-value').each((index,ele)=>{
          let amount = $(ele).html().split('$')[1];
          total += +(amount);
        });
        $('#expense-total').val(total.toFixed(2));
        buildGraph();
      }

      function calculateIncomeTotals(){
        let incomeCount = 0.0;
        $('.income').each((index, ele)=>{
          let amount = $(ele).find('.income-amount').val();
          amount = +amount;
          incomeCount += amount;
        });
        incomeCount = incomeCount.toFixed(2);
        $('#income-total').val(incomeCount);
        buildGraph();
      }

      function buildGraph(){
        let data = [];
        let income = +($('#income-total').val());
        let expenses = +($('#expense-total').val());
        let diff = income-expenses;
        let surplusPercent = diff/income*100;
        setDiff(diff);
        if (income <= 0 || $('.expense').length < 1){
          return;
        }
        $('.expense').each((index, ele)=>{
          let name = $(ele).find('.expense-name').val();
          let cost = $(ele).find('.expense-value').html();
          cost = +cost.split('$')[1];
          let percent = (cost/income).toFixed(2);
          data.push({y: ((+percent)*100), label: name});
        });

        data.unshift({y: surplusPercent, label: "surplus"})
        var chart = new CanvasJS.Chart("chartContainer", {
        	animationEnabled: false,
        	title: {
        		text: "My Budget"
        	},
        	data: [{
        		type: "pie",
        		startAngle: 240,
        		yValueFormatString: "##0.00\"%\"",
        		indexLabel: "{label} {y}",
        		dataPoints: data
        	}]
        });
        chart.render();
      }

      function setDiff(diff){
        $('#diff-box').val(`${diff>=0?'':'-'}$${Math.abs(diff).toFixed(2)}`);
        if(diff > 0){
          $('#diff-box').addClass('bg-success text-light');
          $('#diff-box').removeClass('bg-danger');
        }else if(diff === 0){
          $('#diff-box').removeClass('bg-success text-light');
          $('#diff-box').removeClass('bg-danger text-light');
        }else{
          $('#diff-box').removeClass('bg-success');
          $('#diff-box').addClass('bg-danger text-light');
        }
      }

      function resetBudget(verify){
        if(verify){
          if(!confirm('All unsaved budget data will be lost. Are you sure?')){
            return
          }
        }
        $('#income-container').empty();
        $('#income-total').val('0.00');
        $('#expense-container').empty();
        $('#expense-total').val('0.00');

        var chart = new CanvasJS.Chart("chartContainer", {});
        buildGraph();
      }

      function loadBudget(){
        console.log('load budget');
      }

      function saveBudgetModal(){
        $('#saveModal').modal('toggle');
      }

      function saveBudget(){
        let saveNameValue = $('#save-name').val();
        if(localStorage.getItem(saveNameValue)){
          if(!confirm(`There is already a saved budget called "${saveNameValue}"". Would you like to overwrite it?`)){
            return;
          }
        }

        let budget = {};
        budget.name = saveNameValue;
        budget.dateSaved = Date.now();
        budget.incomes = [];
        budget.expenses =[];
        $('.income').each((index, ele)=>{
          budget.incomes.push({
            name: $(ele).find('.income-input').val(),
            value: Number($(ele).find('.income-amount').val())
          });
        });

        $('.expense').each((index, ele)=>{
          let val = $(ele).find('.expense-input').val();
          if(val.indexOf('%') > -1){
            let percentage = val.split('%')[0];
            if(isNaN(percentage)){
              val = 0;
            }
          }else{
            val = Number(val);
          }

          budget.expenses.push({
            name: $(ele).find('.expense-name').val(),
            value: val
          });
        });
        localStorage.setItem(saveNameValue, JSON.stringify(budget));
        $('#save-name').val('')
        $('#saveModal').modal('toggle');
      }

    </script>




    <!-- handlebar template -->
    <script id="income-template" type="text/x-handlebars-template">
      <div class="income source mb-3 form-inline col-sm-12">
        <button class="btn btn-default col-sm-1 remove-button">
          <i class="fas fa-times-circle"></i>
        </button>
        <input type="text" class="income-input form-control col-sm-4 mr-1" placeholder="INCOME SOURCE"/>
        <input type ="number" step="0.01" class="income-input form-control col-sm-2  mr-1 income-amount">
      </div>
    </script>

    <script id="expense-template" type="text/x-handlebars-template">
      <div  class="expense source mb-3 form-inline col-sm-12">
        <button  class="btn btn-default col-sm-1 remove-button">
          <i class="fas fa-times-circle"></i>
        </button>
        <input type="text" class="expense-name form-control col-sm-4 mr-1" placeholder="EXPENSE SOURCE"/>
        <input type ="text" step="0.01" class="form-control col-sm-2  mr-1 expense-input">
        <span class="expense-value col-sm-1 float-left offset-sm-3">$0.00</span>
      </div>
    </script>



  </body>
</html>
